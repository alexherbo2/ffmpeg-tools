#!/bin/sh

if test $# -ne 2; then
  cat <<'EOF' | sed -E 's/^ {4}//' > /dev/stderr
    Usage
    ‾‾‾‾‾
    ffmpeg-to-gif <input> <output>

    Examples
    ‾‾‾‾‾‾‾‾
    ffmpeg-to-gif input.mkv output.gif
EOF
  exit 1
fi

state=$(mktemp -d)
palette=$state/palette.png
trap 'rm -Rf "$state"' EXIT

filters='fps=15,scale=1080:-1:flags=lanczos'

input=$1 output=$2
ffmpeg -i "$input" -vf "$filters,palettegen" -y "$palette"
ffmpeg -i "$input" -i "$palette" -lavfi "$filters [x]; [x][1:v] paletteuse" -y "$output"
